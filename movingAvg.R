#
# script to calculate and validate buy signal 
#  uses csvs generated by getquotes.py
#

library(plyr)  # rbind.fill
library(dplyr) # %>%
library(ggplot2)

#library(devtools); install('smquote')
library(smquote) # make.history





# put all the csv files into a list
quotes <- lapply(Sys.glob('data/*csv'),read.table,header=T,sep=",")
# collapse list into 1 dataframe, calculations
quotesdf <- rbind.fill(quotes) 
# remove stocks that have too few time points

quotesdfms <- make.history(quotesdf,20)
qbak <- quotesdfms 


#see
print(summary(quotesdfms$gprct))
#data.frame(tail(quotesdf,n=100))

p<-ggplot(qbak%>%filter(sell),aes(x=buy,y=gprct))+geom_point()
ggsave('gainbybuy.png',p)
qbak %>% mutate(bg=cut(buy,c(1:10))) %>% filter(abs(gprct)<10**3) %>% group_by(bg) %>% summarise(mean(gprct),sd(gprct),n=n(), length(unique(Name)))
